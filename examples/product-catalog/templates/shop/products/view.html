{% extends "layout" %}

{% block title %}
{% if items is not empty %}{{ items[0].data.name }} - {% endif %}Product Catalog
{% endblock %}

{% block main %}
{% if items is not empty %}
    {% set product = items[0] %}

    <!-- Breadcrumb navigation -->
    <nav aria-label="breadcrumb">
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/shop/products">Products</a></li>
            <li>{{ product.data.name }}</li>
        </ul>
    </nav>

    <div class="grid" style="--grid-columns: 2; gap: 2rem; margin-top: 2rem;">
        <div>
            <article id="product-details">
                <header>
                    <h1>{{ product.data.name }}</h1>
                    {% if product.data.description is not null %}
                        <p>{{ product.data.description }}</p>
                    {% endif %}
                </header>

                <h2 style="color: var(--pico-primary); margin: 1rem 0;">${{ product.data.price }}</h2>

                <p>
                    {% if product.data.stock > 0 %}
                        <mark>✓ In Stock: {{ product.data.stock }} units available</mark>
                    {% else %}
                        <mark style="background-color: var(--pico-del-color);">✗ Out of Stock</mark>
                    {% endif %}
                </p>

                <p style="margin: 1rem 0;">
                    <strong>Category:</strong> <mark>{{ product.data.category }}</mark>
                </p>

                {% if product.data.tags is not null and product.data.tags is not empty %}
                    <p style="margin: 1rem 0;">
                        <strong>Tags:</strong>
                        {% for tag in product.data.tags %}
                            <kbd>{{ tag }}</kbd>
                        {% endfor %}
                    </p>
                {% endif %}

                {% if product.data.createdAt is not null %}
                    <p><small>Added: {{ product.data.createdAt }}</small></p>
                {% endif %}

                <footer style="margin-top: 2rem;">
                    <div class="grid">
                        <a href="{{ path | parentPath }}" role="button" class="secondary">← Back to Products</a>

                        {% if roles is not empty and roles contains 'admin' %}
                            <button hx-get="{{ path }}"
                                    hx-target="#product-form"
                                    hx-swap="innerHTML"
                                    onclick="document.getElementById('product-details').style.display='none'; document.getElementById('product-form').style.display='block';">
                                Edit Product
                            </button>

                            <button class="secondary" onclick="deleteProduct()">Delete Product</button>
                        {% endif %}
                    </div>
                </footer>
            </article>

            <!-- Edit form container (hidden by default) -->
            <div id="product-form" style="display: none;"></div>
        </div>

        <div>
            <article>
                <header>
                    <h3>Product Information</h3>
                </header>
                <table>
                    <tbody>
                        <tr>
                            <th scope="row">ID</th>
                            <td><code style="font-size: 0.875rem;">{{ product._id.value }}</code></td>
                        </tr>
                        <tr>
                            <th scope="row">Category</th>
                            <td>{{ product.data.category }}</td>
                        </tr>
                        <tr>
                            <th scope="row">Price</th>
                            <td><strong>${{ product.data.price }}</strong></td>
                        </tr>
                        <tr>
                            <th scope="row">Stock</th>
                            <td>{{ product.data.stock }} units</td>
                        </tr>
                    </tbody>
                </table>
            </article>

            <article>
                <header>
                    <h3>Raw JSON</h3>
                </header>
                <pre><code style="font-size: 0.875rem;">{{ product.data | toJson }}</code></pre>
            </article>
        </div>
    </div>

{% else %}
    <article>
        <header>
            <h2>Product Not Found</h2>
        </header>
        <p>The product you're looking for doesn't exist or has been removed.</p>
        <footer>
            <a href="/shop/products" role="button">← Back to Products</a>
        </footer>
    </article>
{% endif %}
{% endblock %}

{% block script %}
<script>
async function deleteProduct() {
    if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch('{{ path }}', {
            method: 'DELETE',
            credentials: 'include'
        });

        if (response.ok) {
            // Redirect to product list
            globalThis.location.href = '{{ path | parentPath }}';
        } else {
            alert('Error deleting product: ' + response.statusText);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Check if ?mode=edit is in the URL and automatically open edit form
globalThis.addEventListener('DOMContentLoaded', function() {
    const params = new URLSearchParams(globalThis.location.search);
    if (params.get('mode') === 'edit') {
        // Trigger the edit button click
        const editButton = document.querySelector('button[hx-target="#product-form"]');
        if (editButton) {
            editButton.click();
        }
    }
});
</script>
{% endblock %}

# Product Catalog Example Configuration
# This is a complete configuration that includes base settings plus example-specific additions
# Volume-mounted configs completely replace the baked-in base config, so all settings must be included

/core:
  name: facet-product-catalog

/ping:
  msg: Facet Product Catalog Example

/http-listener:
  host: 0.0.0.0
  port: 8080

/logging:
  log-level: info
  packages: [org.restheart, org.facet]
  full-stacktrace: true
  ansi-console: true
  requests-log-mode: 1

/mclient:
  connection-string: "mongodb://mongodb"

/mongo/mongo-mounts:
  - what: "*"
    where: /

# File ACL Authorizer - defines permissions for users and roles
/fileAclAuthorizer:
  enabled: true
  permissions:
    # Unauthenticated users can access static assets
    - roles: ['$unauthenticated']
      predicate: >
        path('/favicon.ico') or path-prefix('/apple-touch-icon')
        or path('/robots.txt') or path-prefix('/static')
      priority: 999
      mongo:
          allowManagementRequests: false
          allowBulkPatch: false
          allowBulkDelete: false
          allowWriteMode: false
    # Admin can do anything
    - role: admin
      predicate: path-prefix[path=/]
      priority: 0
      mongo:
        readFilter: null
        writeFilter: null
    # Viewer can only read
    - role: viewer
      predicate: path-prefix[path=/]
      priority: 1
      mongo:
        readFilter: null
        writeFilter: '{"_id": {"$exists": false}}'

# Disable unused services for simplicity
/graphql:
  enabled: false

/bruteForceAttackGuard:
  enabled: false

/rndTokenManager:
  enabled: false

/tokenBasicAuthMechanism:
  enabled: false

# JWT configuration for authentication
/jwtTokenManager:
  enabled: true
  ttl: 15
  srv-uri: /token

/jwtConfigProvider:
  key: example-key-change-in-production
  algorithm: HS256
  base64Encoded: false
  issuer: facet-examples

/jwtAuthenticationMechanism:
  enabled: true
  base64Encoded: false
  usernameClaim: sub
  rolesClaim: roles
  fixedRoles: []

/authCookieSetter:
  enabled: true
  name: rh_auth
  # Uncomment and set your domain for production use
  domain: localhost  # RFC 6265 compliant: no leading dot, parent domain only
  path: /
  secure: false  # Must be false for HTTP (localhost development)
  http-only: true
  same-site: true
  # Use Lax to allow cookie on top-level navigations after JS login POST
  # Strict can block cookies in some POST/fetch+redirect flows in browsers.
  same-site-mode: lax
  ttl: 15  # Cookie expiration time in minutes (matches jwtTokenManager/ttl)
  allow-legacy: true  # Allow legacy ?set-auth-cookie query parameter for backward compatibility

/authCookieHandler:
  enabled: true

/authCookieRemover:
  enabled: true
  secure: false
  uri: /logout

# Facet template engine - hot reload enabled for development
/pebble-template-processor:
  enabled: true
  use-file-loader: true
  cache-active: false
  templates-path: /opt/restheart/templates

# Facet HTML interceptor - caching disabled for development
/html-response-interceptor:
  enabled: true
  response-caching: false
  max-age: 5

# Example uses authentication - enable login service
/login-service:
  enabled: true
  uri: /login
  redirect-param: redirect
  default-redirect: /shop/products  # Default redirect after login when no redirect param provided
  roles-endpoint: /roles

# Redirect unauthenticated HTML requests to login
/html-auth-redirect-interceptor:
  enabled: true
  login-uri: /login

# Disable MongoDB-based authentication (use file-based instead)
/mongoRealmAuthenticator:
  enabled: false

/mongoAclAuthorizer:
  enabled: false

# Configure Basic Auth to use file-based authenticator
/basicAuthMechanism:
  enabled: true
  authenticator: fileRealmAuthenticator

# Simple file-based users for this example
/fileRealmAuthenticator:
  enabled: true
  conf-file: /opt/restheart/etc/users.yml

# Serve static assets (favicon, images, etc.)
/static-resources:
  # Serve favicon at root to prevent browser auth popup
  # Browsers automatically request /favicon.ico regardless of <link> tags
  - what: /opt/restheart/static/favicon.ico
    where: /favicon.ico
    embedded: false
  # Serve other static assets from /static directory
  - what: /opt/restheart/static
    where: /static
    embedded: false
